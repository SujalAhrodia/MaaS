--- 
- name: List of namespaces
  command: ip netns list
  register: ns

- name: Make list of existing namespaces
  set_fact:
    nslist: "{{ns.stdout}}"

# - name: Testing task
#   debug:
#     var: nslist

- name: Create a namespace(subnet router)
  command: ip netns add "{{item.tenantname}}_SR"
  with_items:
    - "{{tVar.input}}"
  when: '"{{item.tenantname}}_SR" not in nslist'

- name: Add veth pair on hypervisor
  command: ip link add pns-{{item.tenantname}} type veth peer name {{item.tenantname}}-pns
  with_items:
    - "{{tVar.input}}"
  when: '"{{item.tenantname}}_SR" not in nslist'
  
- name: Add interface to subnet namespace 
  command: ip link set {{item.tenantname}}-pns netns {{item.tenantname}}_SR
  with_items:
    - "{{tVar.input}}"
  when: '"{{item.tenantname}}_SR" not in nslist'
  
- name: Add interface to the PNS
  command: ip link set pns-{{item.tenantname}} netns pns
  with_items:
    - "{{tVar.input}}"
  when: '"{{item.tenantname}}_SR" not in nslist'
  
- name: Configure IP of the PNS interfaces
  command: ip netns exec pns ip addr add {{ vars[item.zone+'_SR']}}.1/30 dev pns-{{item.tenantname}}
  with_items:
    - "{{tVar.input}}"
  when: '"{{item.tenantname}}_SR" not in nslist'
  tags: ip
  
# - name: Configure IP of the SR interfaces
#   command: ip netns exec {{item.tenantname}}_SR ip addr add 20.0.0.2/30 {{item.tenantname}}-pns
#   with_items:
#     - "{{tVar.input}}"
#   when: '"item.tenantname_SR" not in nslist'